<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

    const TRIAL_NUM = 10;
    const TARGET_PROPORTION = 0.1;
    const TARGET_NUM = TRIAL_NUM * TARGET_PROPORTION;
    const NONTARG_NUM = TRIAL_NUM - TARGET_NUM;

    /* setting */
    var survey_trial = {
        type: 'survey-text',
        questions: [{prompt: "subj_num"}],
    }

    /* define instructions trial */
    var instructions = {
        start: {
            type: "image-keyboard-response",
            stimulus: "img/Start.jpg",
            choices: [" "]
        },
        ready: {
            type: "image-keyboard-response",
            stimulus: "img/Ready2Go.jpg",
            choices: [" "]
        },
        intro: [
            {
                type: "image-keyboard-response",
                stimulus: "img/Intro1.jpg",
                choices: [" "]
            },
            {
                type: "image-keyboard-response",
                stimulus: "img/Intro2.jpg",
                choices: [" "]
            },
            {
                type: "image-keyboard-response",
                stimulus: "img/Intro3.jpg",
                choices: [" "]
            },
            {
                type: "image-keyboard-response",
                stimulus: "img/Intro4.jpg",
                choices: [" "]
            }
        ],
        probe: [
            {
                type: "image-keyboard-response",
                stimulus: "img/probe/Probe1.jpg",
                choices: ["1", "2", "3"]
            },
            {
                type: "image-keyboard-response",
                stimulus: "img/probe/Probe2.jpg",
                choices: ["1", "2", "3", "4", "5", "6", "7"]
            }
        ],
        end: {
            type: "image-keyboard-response",
            stimulus: "img/End.jpg",
            choices: [" "]
        },
        pre_sleep: {
            type: "image-keyboard-response",
            stimulus: "img/preSleepiness.jpg",
            choices: ["1", "2", "3", "4"]
        },
        post_sleep: {
            type: "image-keyboard-response",
            stimulus: "img/postSleepiness.jpg",
            choices: ["1", "2", "3", "4"]
        }
    }

    /* define stimulus */
    var non_target_stimuli = [];
    for (var i = 0; i < 10; i++) {
        if (i == 3) continue;
        non_target_stimuli.push({
            stimulus: "<h1>" + i + "</h1>",
            data: { test_part: 'test', correct_response: ' ', isTarget: false }
        });
    }

    var target_stumuli = {
        stimulus: "<h1>3</h1>",
        data: { test_part: 'test', correct_response: jsPsych.NO_KEYS, isTarget: true }
    }

    var blank = {
      type: 'html-keyboard-response',
      stimulus: ' ',
      choices: jsPsych.NO_KEYS,
      trial_duration: 500,
      data: {test_part: 'blank'}
    }

    var test = {
      type: "html-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: [" "],
      data: jsPsych.timelineVariable('data'),
      trial_duration: 2000,
      on_finish: function(data){
        data.correct = ( 
            data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(
                data.correct_response
            ));
        if (data.rt == null) data.time_onset = data.time_elapsed - 2000;
        else data.time_onset = data.time_elapsed - data.rt;
      }
    }

    /* generate random content of test sequence */
    var test_stimuli = [];
    for (var i = 0; i < TARGET_NUM; i++)
        test_stimuli.push(target_stumuli);
    for (var i = 0; i < NONTARG_NUM; i++)
        test_stimuli.push(non_target_stimuli[Math.floor(Math.random() * 9)]);

    var test_procedure = {
      timeline: [blank, test],
      timeline_variables: test_stimuli,
      randomize_order: true
    }


    /* timeline */
    var timeline = [];

    timeline.push(instructions['intro'][0]);
    timeline.push(instructions['intro'][1]);
    timeline.push(instructions['intro'][2]);
    timeline.push(instructions['intro'][3]);
    timeline.push(instructions['pre_sleep']);
    timeline.push(instructions['start']);

    timeline.push(test_procedure);

    timeline.push(instructions['post_sleep']);
    timeline.push(instructions['end']);

    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      on_start: function() {
        // TODO: start recording
      },
      on_finish: function() {
        var mydata =
            jsPsych.data.get()
            .filter({test_part: 'test'})
            .ignore(['internal_node_id', 'key_press', 'trial_index', 'trial_type', 'stimulus', 'test_part', 'correct_response'])
            .csv();
        console.log(mydata);
        // TODO: stop recording
        // TODO: write out data
      }
    });

  </script>
</html>