<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="http://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="stimulus.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
    <div id="wrapper"></div>
    <div class="aselect">
        <label for="audioSource">Audio input source: </label><select id="audioSource"></select>
    </div>

    <div class="vselect">
        <label for="videoSource">Video source: </label><select id="videoSource"></select>
    </div>
    <video class="videostream" autoplay></video>
  </body>
  <script>

    const BLOCK_NUM = 1;
    const TRIAL_NUM = 10;
    const TARGET_PROPORTION = 0.1;
    const TARGET_NUM = TRIAL_NUM * TARGET_PROPORTION;
    const NONTARG_NUM = TRIAL_NUM - TARGET_NUM;

    var SUBJECT = -1;

    /* Socket */

    var socket = io.connect();

    /* Vid */
    const videoElement = document.querySelector('video');
    const audioSelect = document.querySelector('select#audioSource');
    const videoSelect = document.querySelector('select#videoSource');
    var recorder;
    var allChunks = [];

    audioSelect.onchange = getStream;
    videoSelect.onchange = getStream;

    function gotDevices(deviceInfos) {
      for (let i = 0; i !== deviceInfos.length; ++i) {
        const deviceInfo = deviceInfos[i];
        const option = document.createElement('option');
        option.value = deviceInfo.deviceId;
        if (deviceInfo.kind === 'audioinput') {
          option.text = deviceInfo.label ||
            'microphone ' + (audioSelect.length + 1);
          audioSelect.appendChild(option);
        } else if (deviceInfo.kind === 'videoinput') {
          option.text = deviceInfo.label || 'camera ' +
            (videoSelect.length + 1);
          videoSelect.appendChild(option);
        } else {
          console.log('Found another kind of device: ', deviceInfo);
        }
      }
    }

    function getStream() {
      if (window.stream) {
        window.stream.getTracks().forEach(function(track) {
          track.stop();
        });
      }

      const constraints = {
        audio: {
          deviceId: {exact: audioSelect.value}
        },
        video: {
          deviceId: {exact: videoSelect.value}
        }
      };

      navigator.mediaDevices.getUserMedia(constraints).
        then(gotStream).catch(handleError);
    }

    function gotStream(stream) {
      // window.stream = stream; // make stream available to console
      // videoElement.srcObject = stream;
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = pushblob;
      recorder.onstop = stoprecord;
      recorder.start();
    }

    function handleError(error) {
      console.error('Error: ', error);
    }

    function pushblob(e) {
        allChunks.push(e.data);
        console.log("!!!!");
    }

    function stoprecord() {
        var fullBlob = new Blob(allChunks);
        window.fb = fullBlob;
        window.dl = download;
        console.log(allChunks);
        console.log(fullBlob);
        download(fullBlob, 'media.webm');
    }


    /****************************** define timelines ******************************/

    var blank = {
      type: 'html-keyboard-response',
      stimulus: ' ',
      choices: jsPsych.NO_KEYS,
      trial_duration: 500,
      data: {test_part: 'blank'}
    }

    var test = {
      type: "html-button-response",
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: [" "],
      button_html: '<button class="jspsych-btn" style="width: 80vw; height: 30vh; position: relative; top: 20vh;">%choice%</button>',
      data: jsPsych.timelineVariable('data'),
      trial_duration: 2000,
      on_finish: function(data){
        data.test_part = 'test';
        data.correct = ( data.button_pressed == data.correct_response );
        if (data.rt == null) data.time_onset = data.time_elapsed - 2000;
        else data.time_onset = data.time_elapsed - data.rt;
      }
    }

    var probe = {
        type: jsPsych.timelineVariable('type'),
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: jsPsych.timelineVariable('choices'),
        data: jsPsych.timelineVariable('data'),
        on_finish: function(data){
            data.test_part = 'prob';
            data.ans = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press);
        }
    }

    var intro = {
        type: 'html-button-response',
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['continue'],
        data: jsPsych.timelineVariable('data'),
        test_part: 'intro'
    }

    var subj_num = {
        type: 'survey-text',
        questions: [{prompt: "subj_num"}],
        on_finish: function(data){
            SUBJECT = JSON.parse(data.responses)["Q0"];
            socket.emit('subj_num', SUBJECT);
        }
    }


    /****************************** define functions ******************************/

    function generate_test_procedure(t, nt) {
        test_stimuli = [];
        for (var i = 0; i < t; i++)
            test_stimuli.push(target_stumuli);
        for (var i = 0; i < nt; i++)
            test_stimuli.push(non_target_stimuli[Math.floor(Math.random() * 9)]);

        return {
            timeline: [blank, test],
            timeline_variables: test_stimuli,
            randomize_order: true
        }
    }

    function get_probe(x) {
        return {
            timeline: [probe],
            timeline_variables: [x]
        }
    }

    function get_intro(x) {
        return {
            timeline: [intro],
            timeline_variables: [instructions[x]]
        }
    }

    function get_intro_index(i) {
        return {
            timeline: [intro],
            timeline_variables: [instructions['intro'][i]]
        }
    }

    function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    /******************************* prepare timelime ******************************/

    var timeline = [];
    timeline.push(subj_num);
    timeline.push(get_intro_index(0));
    timeline.push(get_intro_index(1));
    timeline.push(get_intro_index(2));
    timeline.push(get_intro_index(3));
    timeline.push(pre_sleep);
    timeline.push(get_intro('start'));

    for (var i = 0; i < BLOCK_NUM; i++) {
        timeline.push(get_intro('ready'));
        timeline.push(generate_test_procedure(TARGET_NUM, NONTARG_NUM));
    }

    timeline.push(post_sleep);
    timeline.push(get_intro('end'));

    navigator.mediaDevices.enumerateDevices().then(gotDevices).then(getStream).catch(handleError);
    videoElement.style.display = 'none';
    document.querySelector('.aselect').style.display = 'none';
    document.querySelector('.vselect').style.display = 'none';


    /****************************** start the experiment ******************************/

    jsPsych.init({
        timeline: timeline,
        display_element: 'wrapper',
        on_finish: function() {
            recorder.stop();
            jsPsych.data.displayData();
            var dt = jsPsych.data.get();
            var res_data = dt.filter({test_part: 'test'})
                .ignore(['internal_node_id', 'trial_index', 'trial_type', 'stimulus', 'test_part', 'correct_response'])
                .csv();
            var prob_data = dt.filter({test_part: 'prob'}).ignore(['internal_node_id', 'key_press', 'trial_index', 'trial_type', 'test_part'])
                .csv();
            download(res_data + prob_data, "test.csv");
        }
    });

  </script>
</html>